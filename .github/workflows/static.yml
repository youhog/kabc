name: ç¶²é æ›´æ–°

on:
  repository_dispatch:
   types: [trigger-static]
  workflow_dispatch:
  push:
    branches:
      - main
      - youzih/dev/*
      - Youzih/dev/*
    paths:
      - '**'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: æª¢æŸ¥
        uses: actions/checkout@v4

      # ðŸ” Step 1. è¨­å®šéƒ¨ç½²æ‘˜è¦ (ç§»é™¤éƒ¨ç½²ç™½åå–®æª¢æŸ¥)
      - name: è¨­å®šéƒ¨ç½²æ‘˜è¦
        id: check
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "ç›®å‰åˆ†æ”¯: $BRANCH"

          if [ "$BRANCH" = "main" ]; then
            SUMMARY="âœ… å…è¨±éƒ¨ç½²ï¼šmain åˆ†æ”¯æœ‰è®Šæ›´ï¼Œç„¡ç™½åå–®é™åˆ¶ã€‚"
          else
            SUMMARY="âœ… éž main åˆ†æ”¯ï¼Œè‡ªå‹•å…è¨±éƒ¨ç½²ã€‚"
          fi

          # è¨­ç½® ALLOW_DEPLOY=trueï¼Œç¢ºä¿å¾ŒçºŒæ­¥é©Ÿå§‹çµ‚åŸ·è¡Œ
          echo "ALLOW_DEPLOY=true" >> $GITHUB_ENV
          echo "SUMMARY=$SUMMARY" >> $GITHUB_ENV

      # ðŸš€ Step 2. åŸ·è¡Œéƒ¨ç½²æ­¥é©Ÿ
      - name: æ³¨å…¥é…ç½®è®Šæ•¸
        if: env.ALLOW_DEPLOY == 'true'
        run: |
          # æ³¨å…¥å€‰åº«å’Œç”¨æˆ¶å
          sed -i "s|'REPO_OWNER_USERNAME_youhog'|'${{ secrets.REPO_OWNER_USERNAME }}'|g" index.html
          sed -i "s|'REPO_NAME_kabc'|'${{ secrets.REPO_NAME }}'|g" index.html
          
          # æ³¨å…¥åŠ å¯† Token åˆ° DEPLOYED_ENCRYPTED_TOKEN è®Šæ•¸ (ä¿ç•™ç©ºå€¼çµ¦å‰ç«¯å¯†ç¢¼è¼¸å…¥æ©Ÿåˆ¶)
          sed -i "s|const DEPLOYED_ENCRYPTED_TOKEN = '';|const DEPLOYED_ENCRYPTED_TOKEN = '${{ secrets.AUTH_TOKEN_SECRET }}';|g" index.html
          # ç§»é™¤ AUTH_PASSWORD_SECRET çš„æ³¨å…¥
          sed -i '/const AUTH_PASSWORD_SECRET =/d' index.html


      - name: è¨­å®šé é¢
        if: env.ALLOW_DEPLOY == 'true'
        uses: actions/configure-pages@v5

      - name: ä¸Šå‚³
        if: env.ALLOW_DEPLOY == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: æ›´æ–°
        if: env.ALLOW_DEPLOY == 'true'
        id: deployment
        uses: actions/deploy-pages@v4

      # ðŸ“‹ Step 4. è¼¸å‡ºéƒ¨ç½²æ‘˜è¦
      - name: Log Summary
        if: always()
        run: |
          echo "=============================="
          echo "ðŸ“¦ GitHub Pages éƒ¨ç½²æ‘˜è¦"
          echo "=============================="
          echo "ðŸ”¹ åˆ†æ”¯ï¼š${GITHUB_REF#refs/heads/}"
          echo "ðŸ”¹ ç‹€æ…‹ï¼š${SUMMARY}"
          echo "ðŸ”¹ åŸ·è¡Œè€…ï¼š${GITHUB_ACTOR}"
          echo "ðŸ”¹ Commit è¨Šæ¯ï¼š${GITHUB_EVENT_HEAD_COMMIT_MESSAGE:-N/A}"
          echo "=============================="

          echo "### ðŸ§¾ éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**ï¼š${GITHUB_REF#refs/heads/}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‹€æ…‹**ï¼š${SUMMARY}" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸ·è¡Œè€…**ï¼š${GITHUB_ACTOR}" >> $GITHUB_STEP_SUMMARY
