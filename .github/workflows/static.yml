name: ç¶²é æ›´æ–°

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - youzih/dev/*
      - Youzih/dev/*
    paths:
      - '**'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: æª¢æŸ¥
        uses: actions/checkout@v4

      # ðŸ” Step 1. åˆ¤æ–·æ˜¯å¦å…è¨±éƒ¨ç½²
      - name: æª¢æŸ¥æ˜¯å¦å…è¨± main éƒ¨ç½²
        id: check
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "ç›®å‰åˆ†æ”¯: $BRANCH"

          ALLOW_DEPLOY=true
          SUMMARY=""

          if [ "$BRANCH" = "main" ]; then
            echo "ðŸ” main åˆ†æ”¯åµæ¸¬ä¸­..."
            git fetch origin main --depth=2
            CHANGED_FILES=$(git diff --name-only HEAD~1)

            echo "è®Šæ›´æª”æ¡ˆå¦‚ä¸‹ï¼š"
            echo "$CHANGED_FILES"

            if ! echo "$CHANGED_FILES" | grep -E '(^data/portfolio-data.json$|^\.github/workflows/(0deploy\.yml|static\.yml)$)' > /dev/null; then
              echo "ðŸš« main åˆ†æ”¯ä¿®æ”¹çš„æª”æ¡ˆä¸åœ¨ç™½åå–®ä¸­ï¼Œè·³éŽéƒ¨ç½²ã€‚"
              ALLOW_DEPLOY=false
              SUMMARY="ðŸš« è·³éŽéƒ¨ç½²ï¼šmain åˆ†æ”¯è®Šæ›´çš„æª”æ¡ˆä¸åœ¨ç™½åå–®ä¸­ã€‚"
            else
              SUMMARY="âœ… å…è¨±éƒ¨ç½²ï¼šmain åˆ†æ”¯æœ‰è®Šæ›´æŒ‡å®šæª”æ¡ˆã€‚"
            fi
          else
            SUMMARY="âœ… éž main åˆ†æ”¯ï¼Œè‡ªå‹•å…è¨±éƒ¨ç½²ã€‚"
          fi

          echo "ALLOW_DEPLOY=$ALLOW_DEPLOY" >> $GITHUB_ENV
          echo "SUMMARY=$SUMMARY" >> $GITHUB_ENV

      # ðŸ›‘ Step 2. å¦‚æžœä¸å…è¨±éƒ¨ç½²ï¼Œç›´æŽ¥çµæŸ
      - name: åœæ­¢éƒ¨ç½²ï¼ˆè‹¥ä¸å…è¨±ï¼‰
        if: env.ALLOW_DEPLOY == 'false'
        run: |
          echo "ðŸ›‘ è·³éŽéƒ¨ç½²"
          exit 0

      # ðŸš€ Step 3. åŸ·è¡Œéƒ¨ç½²æ­¥é©Ÿ
      - name: æ³¨å…¥é…ç½®è®Šæ•¸
        if: env.ALLOW_DEPLOY == 'true'
        run: |
          sed -i "s|'REPO_OWNER_USERNAME_youhog'|'${{ secrets.REPO_OWNER_USERNAME }}'|g" index.html
          sed -i "s|'REPO_NAME_kabc'|'${{ secrets.REPO_NAME }}'|g" index.html
          sed -i "s|// è¨»è§£ï¼šAUTH_TOKEN_SECRET|const AUTH_TOKEN_SECRET = '${{ secrets.AUTH_TOKEN_SECRET }}';|g" index.html
          sed -i "s|// è¨»è§£ï¼šAUTH_PASSWORD_SECRET|const AUTH_PASSWORD_SECRET = '${{ secrets.AUTH_PASSWORD_SECRET }}';|g" index.html

      - name: è¨­å®šé é¢
        if: env.ALLOW_DEPLOY == 'true'
        uses: actions/configure-pages@v5

      - name: ä¸Šå‚³
        if: env.ALLOW_DEPLOY == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: æ›´æ–°
        if: env.ALLOW_DEPLOY == 'true'
        id: deployment
        uses: actions/deploy-pages@v4

      # ðŸ“‹ Step 4. è¼¸å‡ºéƒ¨ç½²æ‘˜è¦
      - name: Log Summary
        if: always()
        run: |
          echo "=============================="
          echo "ðŸ“¦ GitHub Pages éƒ¨ç½²æ‘˜è¦"
          echo "=============================="
          echo "ðŸ”¹ åˆ†æ”¯ï¼š${GITHUB_REF#refs/heads/}"
          echo "ðŸ”¹ ç‹€æ…‹ï¼š${SUMMARY}"
          echo "ðŸ”¹ åŸ·è¡Œè€…ï¼š${GITHUB_ACTOR}"
          echo "ðŸ”¹ Commit è¨Šæ¯ï¼š${GITHUB_EVENT_HEAD_COMMIT_MESSAGE:-N/A}"
          echo "=============================="

          echo "### ðŸ§¾ éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**ï¼š${GITHUB_REF#refs/heads/}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‹€æ…‹**ï¼š${SUMMARY}" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸ·è¡Œè€…**ï¼š${GITHUB_ACTOR}" >> $GITHUB_STEP_SUMMARY
