name: 網頁更新

on:
  repository_dispatch:
   types: [trigger-static]
  workflow_dispatch:
  push:
    branches:
      - main
      - youzih/dev/*
      - Youzih/dev/*
    paths:
      - 'data/portfolio-data.json'  # 監聽資料檔變更

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 檢查
        uses: actions/checkout@v4

      # 🔍 Step 1. 設定部署摘要 (移除部署白名單檢查)
      - name: 設定部署摘要
        id: check
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "目前分支: $BRANCH"

          if [ "$BRANCH" = "main" ]; then
            SUMMARY="✅ 允許部署：main 分支有變更，無白名單限制。"
          else
            SUMMARY="✅ 非 main 分支，自動允許部署。"
          fi

          # 設置 ALLOW_DEPLOY=true，確保後續步驟始終執行
          echo "ALLOW_DEPLOY=true" >> $GITHUB_ENV
          echo "SUMMARY=$SUMMARY" >> $GITHUB_ENV

      # 🚀 Step 2. 執行部署步驟
      - name: 注入配置變數
        if: env.ALLOW_DEPLOY == 'true'
        run: |
          # 注入倉庫和用戶名
          sed -i "s|'REPO_OWNER_USERNAME_youhog'|'${{ secrets.REPO_OWNER_USERNAME }}'|g" index.html
          sed -i "s|'REPO_NAME_kabc'|'${{ secrets.REPO_NAME }}'|g" index.html
          
          # 注入加密 Token 到 DEPLOYED_ENCRYPTED_TOKEN 變數 (保留空值給前端密碼輸入機制)
          sed -i "s|const DEPLOYED_ENCRYPTED_TOKEN = '';|const DEPLOYED_ENCRYPTED_TOKEN = '${{ secrets.AUTH_TOKEN_SECRET }}';|g" index.html
          # 移除 AUTH_PASSWORD_SECRET 的注入
          sed -i '/const AUTH_PASSWORD_SECRET =/d' index.html


      - name: 設定頁面
        if: env.ALLOW_DEPLOY == 'true'
        uses: actions/configure-pages@v5

      - name: 上傳
        if: env.ALLOW_DEPLOY == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: 更新
        if: env.ALLOW_DEPLOY == 'true'
        id: deployment
        uses: actions/deploy-pages@v4

      # 📋 Step 4. 輸出部署摘要
      - name: Log Summary
        if: always()
        run: |
          echo "=============================="
          echo "📦 GitHub Pages 部署摘要"
          echo "=============================="
          echo "🔹 分支：${GITHUB_REF#refs/heads/}"
          echo "🔹 狀態：${SUMMARY}"
          echo "🔹 執行者：${GITHUB_ACTOR}"
          echo "🔹 Commit 訊息：${GITHUB_EVENT_HEAD_COMMIT_MESSAGE:-N/A}"
          echo "=============================="

          echo "### 🧾 部署摘要" >> $GITHUB_STEP_SUMMARY
          echo "- **分支**：${GITHUB_REF#refs/heads/}" >> $GITHUB_STEP_SUMMARY
          echo "- **狀態**：${SUMMARY}" >> $GITHUB_STEP_SUMMARY
          echo "- **執行者**：${GITHUB_ACTOR}" >> $GITHUB_STEP_SUMMARY
